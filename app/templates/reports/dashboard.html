{% extends "base.html" %}

{% block title %}Reports Dashboard - PersonaMap{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-graph-up"></i> Reports Dashboard</h1>
                <p class="text-muted">Analytics and insights for your persona mapping</p>
            </div>
            <div class="btn-group" role="group">
                <a href="{{ url_for('reports.export_personas') }}" class="btn btn-outline-primary">
                    <i class="bi bi-download"></i> Export Personas
                </a>
                <a href="{{ url_for('reports.export_mappings') }}" class="btn btn-outline-success">
                    <i class="bi bi-download"></i> Export Mappings
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Overview Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ stats.total_personas }}</h4>
                        <p class="mb-0">Active Personas</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-people display-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ stats.total_pages_crawled }}</h4>
                        <p class="mb-0">Pages Crawled</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-file-earmark-text display-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ stats.total_mappings }}</h4>
                        <p class="mb-0">Content Mappings</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-diagram-3 display-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ stats.high_confidence_mappings }}</h4>
                        <p class="mb-0">High Confidence</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-star-fill display-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Persona Performance -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart"></i> Persona Performance
                </h5>
            </div>
            <div class="card-body">
                {% if persona_stats %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Persona</th>
                                    <th>Mappings</th>
                                    <th>Avg Confidence</th>
                                    <th>Performance</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in persona_stats %}
                                <tr>
                                    <td>
                                        <strong>{{ stat.title }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ stat.mapping_count }}</span>
                                    </td>
                                    <td>
                                        {% set avg_conf = (stat.avg_confidence * 100)|round(1) if stat.avg_confidence else 0 %}
                                        {% set conf_class = 'success' if avg_conf >= 70 else 'warning' if avg_conf >= 40 else 'danger' %}
                                        <span class="badge bg-{{ conf_class }}">{{ avg_conf }}%</span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-{{ conf_class }}" role="progressbar" 
                                                 style="width: {{ avg_conf }}%" 
                                                 aria-valuenow="{{ avg_conf }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                {{ avg_conf }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-bar-chart display-4 text-muted"></i>
                        <h5 class="mt-3">No Persona Data</h5>
                        <p class="text-muted">Create personas and run crawl jobs to see performance data.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Crawl Job Performance -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-collection"></i> Recent Crawl Jobs
                </h5>
            </div>
            <div class="card-body">
                {% if job_stats %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Job Name</th>
                                    <th>Pages Crawled</th>
                                    <th>Pages Mapped</th>
                                    <th>Status</th>
                                    <th>Last Run</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in job_stats %}
                                <tr>
                                    <td>
                                        <strong>{{ job.name }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ job.pages_crawled or 0 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ job.pages_mapped or 0 }}</span>
                                    </td>
                                    <td>
                                        {% if job.status == 'completed' %}
                                            <span class="badge bg-success">Completed</span>
                                        {% elif job.status == 'running' %}
                                            <span class="badge bg-primary">Running</span>
                                        {% elif job.status == 'failed' %}
                                            <span class="badge bg-danger">Failed</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ job.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ job.last_run_at.strftime('%Y-%m-%d %H:%M') if job.last_run_at else 'Never' }}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-collection display-4 text-muted"></i>
                        <h5 class="mt-3">No Crawl Jobs</h5>
                        <p class="text-muted">Create crawl jobs to see performance data.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Confidence Distribution -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-pie-chart"></i> Confidence Distribution
                </h5>
            </div>
            <div class="card-body">
                {% if confidence_distribution %}
                    {% for dist in confidence_distribution %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ dist.confidence_range }}</span>
                        <span class="badge bg-primary">{{ dist.count }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-pie-chart display-4 text-muted"></i>
                        <h5 class="mt-3">No Data</h5>
                        <p class="text-muted">No mappings to analyze.</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('personas.create_persona') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Create Persona
                    </a>
                    <a href="{{ url_for('crawler.create_crawl_job') }}" class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Create Crawl Job
                    </a>
                    <a href="{{ url_for('reports.persona_report') }}" class="btn btn-info">
                        <i class="bi bi-people"></i> Persona Report
                    </a>
                    <a href="{{ url_for('reports.content_analysis') }}" class="btn btn-outline-info">
                        <i class="bi bi-file-earmark-bar-graph"></i> Content Analysis
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
